machine:
  environment:
    GODIST: "go1.8.linux-amd64.tar.gz"
    GOROOT: ""
    PATH: "/usr/local/go/bin:/usr/local/go_workspace/bin:~/.go_workspace/bin:${PATH}"
    GOPATH: "${HOME}/.go_workspace:/usr/local/go_workspace:${HOME}/.go_project"
    PROJECT_PATH: "${HOME}/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"

dependencies:
  cache_directories:
    - ~/h2o-2.1.0
    - ~/download
  pre:
    - sudo apt-get update && sudo apt-get install nginx
    - sudo apt-get install cmake build-essential ruby
    - bash ./circle-ci-install-h2o.sh
    - mkdir -p ~/download
    - test -e ~/download/$GODIST || curl -o ~/download/$GODIST https://storage.googleapis.com/golang/$GODIST
    - sudo rm -rf /usr/local/go
    - sudo tar -C /usr/local -xzf ~/download/$GODIST
  override:
    - mkdir -p ~/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}
    - ln -s ${HOME}/${CIRCLE_PROJECT_REPONAME} ${PROJECT_PATH}
    - mkdir -p ${HOME}/.go_workspace/bin
    - curl https://glide.sh/get | GOPATH=${HOME}/.go_workspace sh
    - cd ${PROJECT_PATH} && glide install && go build -v
test:
  override:
    - make -C ${PROJECT_PATH} test

deployment:
  release:
    tag: /v[0-9.]+/
    commands:
      - git fetch --unshallow || true
      - git fetch --tags
      - go get github.com/mitchellh/gox
      - go get github.com/tcnksm/ghr
      - gox --output "dist/{{.Dir}}_{{.OS}}_{{.Arch}}" github.com/shogo82148/go-nginx-oauth2-adapter/cli/go-nginx-oauth2-adapter
      - ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME --replace `git describe --tags` dist/
